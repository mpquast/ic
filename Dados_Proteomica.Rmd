---
title: "Dados Proteomica"
author: "Yasmine"
date: "24 de agosto de 2016"
output: html_document
---

#Objetivo

Queremos saber quais são as proteínas que têm abundância diferentes quando comparamos os controles aos afetados.

Vamos começar lendo os dados:
```{r dados, warning=FALSE}
library(formattable)
library(readxl)
tabela=read_excel("20160718_BPDunifesp_proteinsmeasurements_nofilter.xlsx", skip=2)
tbl=tabela
tabela=tabela[-c(5555:9643),-c(2:11)]
dados=apply(tabela[,-1], 2, as.double)
row.names(dados)=tabela[[1]]
rm(tabela)
```

Vamos trabalhar somente com os "Controles" e "Afetados". Para enxergar melhor o comportamento dos dados vamos aplicar uma transformação nos mesmos. Somaremos, nesse caso,  1 e aplicaremos o log em base 2 em todas as observações de controle e afetados.

Aplicando a transformação:
```{r transformacao}
tran = function(x) log2(x+1)
n.dados=apply(dados, 2, tran)
```

Podemos plotar a densidade para cada indivíduo:
```{r dens.ind, results='hide', fig.align='center'}
fit=apply(n.dados, 2, density)
matx=sapply(fit, '[[', 'x')
maty=sapply(fit, '[[', 'y')
matplot(matx,maty, type='l', lty=1)
```

Como podemos ver existe uma variabilidade muito grande entre as densidades no ponto igual a 0. Se nos restringirmos as proteínas cuja contagem de peptídeo seja maior que 5 a tendência é que essa variabilidade diminua. Isso pode ser visto no gráfico abaixo.

```{r, fig.align='center', fig.cap="Densidade para proteínas com contagem de peptídeo igual ou superior a 5", eval=FALSE}
tbl1=tbl[which('Unique peptides'>=5),]
fit=apply(n.dados[which()], 2, density)
matx=sapply(fit, '[[', 'x')
maty=sapply(fit, '[[', 'y')
matplot(matx,maty, type='l', lty=1)
```


Podemos estudar as correlações entre cada réplica de cada indivíduo. Para mostrar tais correlações podemos fazer alguns gráficos.

```{r, fig.cap="Gráfico de correlação entre as réplicas de cada indivíduo", fig.align='center'}
library(corrplot)
data=as.data.frame(n.dados)
x=cor(data[,1:10])
corrplot(x, method="ellipse")
```

Para garantir que as correlações sejam calculadas para cada individuo entre suas réplicas corretamente, precisamos no certificar de que existam para cada um duas réplicas.

```{r}
nms=colnames(dados)
nms=gsub("--", "-", nms)
amostras = sapply(strsplit(nms, "-"), '[', 1)
replicas = sapply(strsplit(nms, "-"), '[', 2)
#table(amostras, replicas)
```

Como podemos ver, cada um dos indivíduos, seja ele controle ou afetado, temos duas réplicas, com exceção do paciente afetado 73B, portanto não faremos essa análise para ele.

Então podemos calcular as correlações par a par e graficá-las.

```{r cor.pares, fig.cap="Gráfico de dispersão", fig.align='center'}
data=data[,-75]
x=rep(0,length(data)/2)
for (i in 1:(length(data)/2)) {
  x[i]=cor(data[,2*i-1],data[,2*i])
}
hist(x)
```


Analizar-se-a as proteínas com o pacote de $Limma$.
```{r limma}
library("limma")
status=c(rep(0,17),rep(1,21))
dm=model.matrix(~status, data=data)
fit=lmFit(data, desing=dm)
cfit=eBayes(fit)
x=topTable(cfit, coef = 1) #?
table(x)
```

Calcularam-se as correlações entre as duplicatas de pacientes e controles.
```{r cor}
cor=duplicateCorrelation(data, ndups=2)
```

